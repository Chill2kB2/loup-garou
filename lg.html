<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Loup-Garou — Lobby & Partie</title>
  <link rel="icon" href="data:," />

  <style>
    :root{
      --bg1:#07090d;
      --bg2:#0b1020;
      --glass:rgba(255,255,255,.06);
      --glass2:rgba(255,255,255,.10);
      --bd:rgba(255,255,255,.12);
      --txt:#e9eefc;
      --mut:rgba(233,238,252,.72);
      --acc:#7c5cff;
      --acc2:#4dd6ff;
      --ok:#41d37a;
      --bad:#ff5c5c;
      --warn:#ffb020;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:22px;
      --gap:16px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --ui: system-ui, "Segoe UI", Arial;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--ui);
      color:var(--txt);
      background:
        radial-gradient(1000px 700px at 10% 10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 30%, rgba(77,214,255,.10), transparent 55%),
        radial-gradient(1000px 800px at 50% 110%, rgba(65,211,122,.06), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    .app{height:100%; display:flex; flex-direction:column;}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.10);
      backdrop-filter: blur(14px);
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, var(--acc), var(--acc2));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
      flex:0 0 auto;
    }
    .brandText{min-width:0}
    .brand h1{
      font-size:14px; margin:0; letter-spacing:.2px; font-weight:800;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand .sub{
      font-size:12px; color:var(--mut); margin-top:2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .rightbar{display:flex; align-items:center; gap:10px; flex:0 0 auto;}

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      font-size:12px; color:var(--mut);
    }
    .dot{width:9px;height:9px;border-radius:50%; background:rgba(255,255,255,.25);}
    .dot.ok{background:var(--ok); box-shadow:0 0 0 4px rgba(65,211,122,.14)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,92,92,.14)}

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn.primary{border-color:rgba(124,92,255,.35); background:rgba(124,92,255,.18);}
    .btn.danger{border-color:rgba(255,92,92,.35); background:rgba(255,92,92,.14);}
    .btn.ghost{background:transparent;}
    .btn.icon{
      width:42px;height:42px; display:grid;place-items:center;
      padding:0; border-radius:14px; font-size:18px;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .main{
      flex:1 1 auto;
      display:grid;
      grid-template-columns: 1fr 1.1fr;
      gap:var(--gap);
      padding:14px;
      min-height:0;
    }

    .panel{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter: blur(16px);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .panelHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .panelHead h2{margin:0; font-size:13px; letter-spacing:.2px; font-weight:900;}
    .panelHead .hint{font-size:12px; color:var(--mut); white-space:nowrap;}
    .panelBody{padding:12px 14px; overflow:auto; min-height:0;}

    .playersTop{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .readyBadge{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--mut);
    }
    .playersList{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .playerRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
    }
    .pLeft{display:flex; align-items:center; gap:10px; min-width:0;}
    .avatarDot{width:12px;height:12px;border-radius:50%; background:rgba(255,255,255,.22);}
    .avatarDot.alive{background:var(--ok)}
    .pName{font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .pMeta{font-size:12px; color:var(--mut); white-space:nowrap;}
    .tag{
      font-size:11px; padding:6px 9px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      color:var(--mut); background:rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .tag.host{border-color:rgba(255,176,32,.35); background:rgba(255,176,32,.10); color:rgba(255,232,190,.92)}
    .tag.ready{border-color:rgba(65,211,122,.35); background:rgba(65,211,122,.10); color:rgba(205,255,228,.95)}
    .tag.notready{border-color:rgba(255,92,92,.25); background:rgba(255,92,92,.08); color:rgba(255,220,220,.92)}

    .log{
      font-family:var(--mono);
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
      color:rgba(233,238,252,.86);
    }
    .logLine{opacity:.92}
    .logLine.sys{color:rgba(233,238,252,.70)}
    .logLine.err{color:rgba(255,190,190,.95)}
    .logLine.ok{color:rgba(205,255,228,.95)}
    .logLine.emph{color:rgba(255,232,190,.95)}

    .chatBar{
      display:flex; gap:10px;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.12);
    }
    .input{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      outline:none;
      font-size:13px;
    }
    .input::placeholder{color:rgba(233,238,252,.45)}

    .actionbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.14);
      backdrop-filter: blur(14px);
    }
    .phaseBox{display:flex; flex-direction:column; gap:3px; min-width:0;}
    .phaseTitle{font-weight:900; font-size:12px; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .phaseSub{font-size:12px; color:var(--mut); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .actions{display:flex; align-items:center; gap:10px; flex:0 0 auto; flex-wrap:wrap; justify-content:flex-end;}

    .drawerOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      opacity:0; pointer-events:none;
      transition: opacity .15s ease;
      z-index:50;
    }
    .drawerOverlay.open{opacity:1; pointer-events:auto}
    .drawer{
      position:fixed; top:0; right:0; height:100%; width:min(420px, 92vw);
      background:rgba(10,12,18,.86);
      border-left:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(18px);
      box-shadow: -20px 0 70px rgba(0,0,0,.55);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index:60;
      display:flex; flex-direction:column;
    }
    .drawer.open{transform: translateX(0)}
    .drawerHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .drawerHead h3{margin:0; font-size:13px; font-weight:900}
    .drawerBody{
      padding:12px 14px;
      overflow:auto; min-height:0;
      display:flex; flex-direction:column; gap:14px;
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      border-radius:18px;
      padding:12px;
    }
    .row{display:flex; gap:10px; align-items:center}
    .sep{height:1px; background:rgba(255,255,255,.08); margin:8px 0}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .mut{color:var(--mut); font-size:12px}
    .tiny{font-size:11px; color:rgba(233,238,252,.55)}
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:3px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:rgba(233,238,252,.80);
      display:inline-block;
    }

    @media (max-width: 980px){
      .main{grid-template-columns:1fr;}
      .actions{justify-content:flex-start}
    }
  </style>
</head>

<body>
<div class="app">

  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="brandText">
        <h1>Loup-Garou — Lobby & Partie</h1>
        <div class="sub" id="subline">Interface séparée du gameplay: propre, lisible.</div>
      </div>
    </div>
    <div class="rightbar">
      <div class="chip">
        <span class="dot bad" id="statusDot"></span>
        <span id="statusTxt">Déconnecté</span>
      </div>
      <button class="btn icon" id="btnMenu" title="Menu">☰</button>
    </div>
  </header>

  <main class="main">

    <section class="panel" aria-label="Joueurs">
      <div class="panelHead">
        <div class="playersTop">
          <h2>Joueurs</h2>
          <div class="readyBadge" id="readyBadge">Prêts: 0/0</div>
        </div>
        <button class="btn ghost" id="btnCopyLink" title="Copier le lien à partager">Partager</button>
      </div>
      <div class="panelBody">
        <div class="mut" id="playersHint">Min: —. Connecte-toi via le menu (☰).</div>
        <div class="playersList" id="playersList"></div>
      </div>
    </section>

    <section class="panel" aria-label="Journal">
      <div class="panelHead">
        <h2>Journal</h2>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="hint" id="phaseMini">Phase: —</div>
          <button class="btn ghost" id="btnClearLog">Vider</button>
        </div>
      </div>
      <div class="panelBody">
        <div class="log" id="log"></div>
      </div>
      <div class="chatBar">
        <input class="input" id="chatInput" placeholder="Écrire un message… (Entrée pour envoyer)" maxlength="160" />
        <button class="btn primary" id="btnSend">Envoyer</button>
      </div>
    </section>

  </main>

  <footer class="actionbar">
    <div class="phaseBox">
      <div class="phaseTitle" id="phaseTitle">Phase: —</div>
      <div class="phaseSub" id="phaseSub">Connecte-toi via le menu (☰).</div>
    </div>

    <div class="actions">
      <button class="btn" id="btnReady" disabled>Prêt</button>
      <button class="btn primary" id="btnStart" disabled>Démarrer (hôte)</button>
      <button class="btn" id="btnAction" disabled>Action</button>
      <button class="btn danger" id="btnHome">Quitter</button>
    </div>
  </footer>
</div>

<div class="drawerOverlay" id="drawerOverlay"></div>
<aside class="drawer" id="drawer" aria-label="Menu">
  <div class="drawerHead">
    <h3>Menu</h3>
    <button class="btn icon" id="btnCloseMenu" title="Fermer">✕</button>
  </div>

  <div class="drawerBody">

    <div class="card">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px">
        <div>
          <div style="font-weight:900">Connexion</div>
          <div class="tiny">WS : <span class="kbd" id="wsShown">—</span></div>
        </div>
        <button class="btn ghost" id="btnEditWS" title="Changer l'URL WS">WS</button>
      </div>

      <div class="sep"></div>

      <div class="row">
        <input class="input" id="nameInput" placeholder="Ton nom (max 18)" maxlength="18" />
      </div>
      <div style="height:10px"></div>
      <div class="grid2">
        <button class="btn primary" id="btnConnect">Connecter</button>
        <button class="btn danger" id="btnDisconnect" disabled>Déconnecter</button>
      </div>

      <div style="height:10px"></div>
      <div class="mut">
        Si ça échoue au 1er essai sur Render gratuit, retente une fois.
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900">Partie</div>
      <div class="sep"></div>

      <div class="row" style="justify-content:space-between">
        <div class="mut">Ton ID</div>
        <div class="kbd" id="youId">—</div>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:8px">
        <div class="mut">Hôte</div>
        <div class="kbd" id="hostId">—</div>
      </div>

      <div style="height:10px"></div>
      <div class="grid2">
        <button class="btn" id="btnReadyMenu" disabled>Prêt</button>
        <button class="btn primary" id="btnStartMenu" disabled>Démarrer</button>
      </div>

      <div style="height:10px"></div>
      <div class="mut" id="settingsLine">Paramètres: —</div>

      <div id="hostBox" style="display:none; margin-top:12px">
        <div class="sep"></div>
        <div style="font-weight:900; font-size:12px; margin-bottom:8px">Paramètres (hôte)</div>

        <div class="grid2">
          <label class="mut">Loups
            <input class="input" id="optWolvesCount" type="number" min="1" max="4" value="1" />
          </label>
          <label class="mut">Chasseur
            <select class="input" id="optHunterEnabled">
              <option value="1">ON</option>
              <option value="0">OFF</option>
            </select>
          </label>
        </div>

        <div style="height:10px"></div>

        <div class="grid2">
          <label class="mut">Révélation (ms)
            <input class="input" id="optRevealMs" type="number" min="1000" step="500" value="12000" />
          </label>
          <label class="mut">Nuit (ms)
            <input class="input" id="optNightMs" type="number" min="1000" step="500" value="20000" />
          </label>
        </div>

        <div style="height:10px"></div>

        <div class="grid2">
          <label class="mut">Discussion (ms)
            <input class="input" id="optTalkMs" type="number" min="1000" step="500" value="22000" />
          </label>
          <label class="mut">Vote (ms)
            <input class="input" id="optVoteMs" type="number" min="1000" step="500" value="20000" />
          </label>
        </div>

        <div style="height:10px"></div>

        <label class="mut">Tir Chasseur (ms)
          <input class="input" id="optHunterMs" type="number" min="1000" step="500" value="15000" />
        </label>

        <div style="height:10px"></div>
        <button class="btn" id="btnApplySettings">Appliquer</button>
        <div class="tiny" style="margin-top:8px">On enverra exactement les champs que ton serveur utilise: wolvesCount, hunterEnabled, revealMs, nightMs, talkMs, voteMs, hunterMs.</div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900">Quitter</div>
      <div class="sep"></div>
      <button class="btn danger" id="btnQuitToHome">Retour accueil</button>
      <div class="mut" style="margin-top:10px">Déconnexion propre avant retour.</div>
    </div>

  </div>
</aside>

<script>
(() => {
  // ---------------------------
  // CONFIG
  // ---------------------------
  const DEFAULT_WS = "wss://loup-garou-ws.onrender.com/ws";
  const HOME_URL = "index.html";

  const qs = new URLSearchParams(location.search);
  let wsUrl = qs.get("ws") || localStorage.getItem("lg_ws_url") || DEFAULT_WS;

  // ---------------------------
  // DOM
  // ---------------------------
  const $ = (id) => document.getElementById(id);

  const statusDot = $("statusDot");
  const statusTxt = $("statusTxt");
  const subline = $("subline");

  const btnMenu = $("btnMenu");
  const drawer = $("drawer");
  const overlay = $("drawerOverlay");
  const btnCloseMenu = $("btnCloseMenu");

  const wsShown = $("wsShown");
  const btnEditWS = $("btnEditWS");

  const nameInput = $("nameInput");
  const btnConnect = $("btnConnect");
  const btnDisconnect = $("btnDisconnect");

  const btnReady = $("btnReady");
  const btnStart = $("btnStart");
  const btnAction = $("btnAction");
  const btnHome = $("btnHome");

  const btnReadyMenu = $("btnReadyMenu");
  const btnStartMenu = $("btnStartMenu");

  const btnQuitToHome = $("btnQuitToHome");

  const playersHint = $("playersHint");
  const playersList = $("playersList");
  const readyBadge = $("readyBadge");

  const logBox = $("log");
  const btnClearLog = $("btnClearLog");

  const chatInput = $("chatInput");
  const btnSend = $("btnSend");

  const phaseTitle = $("phaseTitle");
  const phaseSub = $("phaseSub");
  const phaseMini = $("phaseMini");

  const btnCopyLink = $("btnCopyLink");

  const youIdEl = $("youId");
  const hostIdEl = $("hostId");
  const settingsLine = $("settingsLine");

  const hostBox = $("hostBox");
  const btnApplySettings = $("btnApplySettings");
  const optWolvesCount = $("optWolvesCount");
  const optHunterEnabled = $("optHunterEnabled");
  const optRevealMs = $("optRevealMs");
  const optNightMs = $("optNightMs");
  const optTalkMs = $("optTalkMs");
  const optVoteMs = $("optVoteMs");
  const optHunterMs = $("optHunterMs");

  // ---------------------------
  // STATE
  // ---------------------------
  let ws = null;
  let connected = false;

  let youId = null;
  let hostId = null;
  let isHost = false;

  let phase = "—";
  let players = []; // [{id,name,ready}]
  let myReady = false;

  let settings = null; // settings reçus
  let minPlayers = 5;
  let allReady = false;

  // ---------------------------
  // UI helpers
  // ---------------------------
  function setStatus(ok, text){
    statusDot.classList.toggle("ok", !!ok);
    statusDot.classList.toggle("bad", !ok);
    statusTxt.textContent = text;
  }

  function log(line, kind="sys"){
    const div = document.createElement("div");
    div.className = "logLine " + (kind || "sys");
    div.textContent = line;
    logBox.appendChild(div);
    logBox.scrollTop = logBox.scrollHeight;
  }

  function clearLog(){ logBox.innerHTML = ""; }

  function openMenu(){
    drawer.classList.add("open");
    overlay.classList.add("open");
  }
  function closeMenu(){
    drawer.classList.remove("open");
    overlay.classList.remove("open");
  }

  function setPhase(p, sub=""){
    phase = p || "—";
    phaseTitle.textContent = "Phase: " + phase;
    phaseMini.textContent = "Phase: " + phase;
    phaseSub.textContent = sub || "";
  }

  function setMyReady(v){
    myReady = !!v;
    const txt = myReady ? "Prêt ✓" : "Prêt";
    btnReady.textContent = txt;
    btnReadyMenu.textContent = txt;
    btnReady.classList.toggle("primary", myReady);
    btnReadyMenu.classList.toggle("primary", myReady);
  }

  function syncHostUI(){
    isHost = (youId != null && hostId != null && youId === hostId);
    hostBox.style.display = isHost ? "block" : "none";

    youIdEl.textContent = youId ?? "—";
    hostIdEl.textContent = hostId ?? "—";

    // Start enabled seulement si host + conditions
    const canStart = connected && isHost && (players.length >= minPlayers) && !!allReady;
    btnStart.disabled = !canStart;
    btnStartMenu.disabled = !canStart;
  }

  function renderPlayers(){
    playersList.innerHTML = "";

    const total = players.length;
    const readyCount = players.filter(p => !!p.ready).length;
    readyBadge.textContent = `Prêts: ${readyCount}/${total}`;

    if(!connected){
      playersHint.textContent = "Connecte-toi via le menu (☰).";
    } else if(total < minPlayers){
      playersHint.textContent = `Min: ${minPlayers}. Actuels: ${total}. Partage le lien.`;
    } else {
      playersHint.textContent = `Min: ${minPlayers}. ${allReady ? "Tous prêts ✅ — l’hôte peut démarrer." : "Attente: tout le monde doit être prêt."}`;
    }

    for(const p of players){
      const row = document.createElement("div");
      row.className = "playerRow";

      const left = document.createElement("div");
      left.className = "pLeft";

      const dot = document.createElement("div");
      dot.className = "avatarDot alive";

      const wrap = document.createElement("div");
      wrap.style.minWidth = "0";

      const name = document.createElement("div");
      name.className = "pName";
      name.textContent = p.name || ("Joueur " + p.id);

      const meta = document.createElement("div");
      meta.className = "pMeta";
      meta.textContent = (p.id === youId ? "toi" : ("#" + p.id));

      wrap.appendChild(name);
      wrap.appendChild(meta);

      left.appendChild(dot);
      left.appendChild(wrap);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.alignItems = "center";

      if(p.id === hostId){
        const t = document.createElement("span");
        t.className = "tag host";
        t.textContent = "Hôte";
        right.appendChild(t);
      }

      const r = document.createElement("span");
      r.className = "tag " + (p.ready ? "ready" : "notready");
      r.textContent = p.ready ? "Prêt" : "Pas prêt";
      right.appendChild(r);

      row.appendChild(left);
      row.appendChild(right);
      playersList.appendChild(row);
    }

    btnReady.disabled = !connected;
    btnReadyMenu.disabled = !connected;

    // action placeholder
    btnAction.disabled = !connected || (phase === "LOBBY");
  }

  function formatSettingsLine(s){
    if(!s) return "Paramètres: —";
    const reveal = Math.round((s.revealMs ?? 0)/1000);
    const night  = Math.round((s.nightMs  ?? 0)/1000);
    const talk   = Math.round((s.talkMs   ?? 0)/1000);
    const vote   = Math.round((s.voteMs   ?? 0)/1000);
    const hunter = Math.round((s.hunterMs ?? 0)/1000);
    const wolves = s.wolvesCount ?? 1;
    const hunterOn = s.hunterEnabled ? "ON" : "OFF";
    return `Paramètres: Loups ${wolves} · Chasseur ${hunterOn} · Rév ${reveal}s · Nuit ${night}s · Disc ${talk}s · Vote ${vote}s · Tir ${hunter}s`;
  }

  function applySettingsToInputs(s){
    if(!s) return;
    if(s.wolvesCount != null) optWolvesCount.value = String(s.wolvesCount);
    optHunterEnabled.value = (s.hunterEnabled ? "1" : "0");
    if(s.revealMs != null) optRevealMs.value = String(s.revealMs);
    if(s.nightMs  != null) optNightMs.value  = String(s.nightMs);
    if(s.talkMs   != null) optTalkMs.value   = String(s.talkMs);
    if(s.voteMs   != null) optVoteMs.value   = String(s.voteMs);
    if(s.hunterMs != null) optHunterMs.value = String(s.hunterMs);
  }

  // ---------------------------
  // WS helpers
  // ---------------------------
  function send(obj){
    if(!ws || ws.readyState !== 1) return;
    ws.send(JSON.stringify(obj));
  }

  function safeParsePlayers(raw){
    // Ton serveur envoie players comme string JSON: "[{\"id\":4,...}]"
    if(Array.isArray(raw)) return raw;
    if(typeof raw === "string"){
      try{
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }
    return [];
  }

  // ---------------------------
  // WS connect / protocol
  // ---------------------------
  function connect(){
    const name = (nameInput.value || "").trim();
    if(name.length < 1){
      log("Choisis un nom avant de te connecter.", "err");
      openMenu();
      nameInput.focus();
      return;
    }
    localStorage.setItem("lg_name", name);

    log(`Connexion… (${wsUrl})`, "sys");
    setStatus(false, "Connexion…");

    try{ ws = new WebSocket(wsUrl); }
    catch{
      log("WebSocket: URL invalide.", "err");
      setStatus(false, "Erreur URL");
      return;
    }

    ws.onopen = () => {
      connected = true;
      setStatus(true, "Connecté");
      subline.textContent = "Connecté. Mets-toi prêt, puis l’hôte démarre.";
      btnDisconnect.disabled = false;
      btnConnect.disabled = true;

      // IMPORTANT: ton serveur sait gérer join (tu l’as vu: name devient “suuu”)
      send({ t:"join", name });

      log(`Connecté en tant que ${name}.`, "ok");
      closeMenu();
    };

    ws.onclose = () => {
      connected = false;
      setStatus(false, "Déconnecté");
      subline.textContent = "Déconnecté.";
      btnDisconnect.disabled = true;
      btnConnect.disabled = false;

      youId = null; hostId = null; isHost = false;
      players = [];
      settings = null;
      minPlayers = 5;
      allReady = false;

      setMyReady(false);
      setPhase("—", "Connecte-toi via le menu (☰).");
      settingsLine.textContent = "Paramètres: —";
      renderPlayers();
      syncHostUI();

      log("Déconnecté.", "sys");
    };

    ws.onerror = () => log("WebSocket: erreur réseau (ou serveur endormi).", "err");

    ws.onmessage = (ev) => {
      let msg = null;
      try{ msg = JSON.parse(ev.data); } catch {
        log(String(ev.data), "sys");
        return;
      }

      // --- protocole exact de ton serveur ---
      switch(msg.t){
        case "welcome": {
          // {"t":"welcome","id":4,"isHost":true,"phase":"LOBBY"}
          youId = msg.id ?? youId;
          if(typeof msg.phase === "string") phase = msg.phase;
          // hostId viendra du message lobby, mais si isHost true, on peut anticiper
          if(msg.isHost === true && hostId == null) hostId = youId;
          setPhase(phase, phase === "LOBBY" ? "En attente des joueurs." : "");
          syncHostUI();
          renderPlayers();
          log(`Bienvenue. Ton id=${youId}.`, "sys");
          break;
        }

        case "lobby": {
          // {"t":"lobby","hostId":4,"phase":"LOBBY","players":"[...]","settings":{...}}
          hostId = msg.hostId ?? hostId;
          if(typeof msg.phase === "string") phase = msg.phase;

          const arr = safeParsePlayers(msg.players);
          players = arr.map(p => ({
            id: p.id,
            name: p.name ?? ("Joueur " + p.id),
            ready: !!p.ready
          }));

          settings = msg.settings ?? settings;

          // settings contient allReady/minPlayers selon tes logs
          if(settings && typeof settings.minPlayers === "number") minPlayers = settings.minPlayers;
          if(settings && typeof settings.allReady === "boolean") allReady = settings.allReady;

          // mon état ready = ce que dit le serveur
          const me = players.find(p => p.id === youId);
          if(me) setMyReady(!!me.ready);

          // UI settings
          settingsLine.textContent = formatSettingsLine(settings);
          applySettingsToInputs(settings);

          // phase text
          const sub =
            phase === "LOBBY"
              ? (players.length < minPlayers
                  ? `Min ${minPlayers} joueurs. Invite tes amis.`
                  : (allReady ? "Tous prêts ✅ — l’hôte peut démarrer." : "Attente: tout le monde doit être prêt."))
              : "Partie en cours.";

          setPhase(phase, sub);

          syncHostUI();
          renderPlayers();
          break;
        }

        case "log": {
          // {"t":"log","text":"...", "emph": false}
          const text = String(msg.text ?? "");
          const kind = msg.emph ? "emph" : "sys";
          log(text, kind);
          break;
        }

        case "chat": {
          // si tu l’ajoutes côté serveur plus tard
          log(`[${msg.from ?? "?"}] ${msg.text ?? ""}`, "sys");
          break;
        }

        case "error": {
          log(`Erreur: ${msg.message ?? "?"}`, "err");
          break;
        }

        default: {
          log(`MSG ${msg.t}: ${JSON.stringify(msg)}`, "sys");
          break;
        }
      }
    };
  }

  function disconnect(){
    if(ws){
      try{ send({t:"leave"}); } catch {}
      try{ ws.close(); } catch {}
    }
  }

  // ---------------------------
  // Actions
  // ---------------------------
  function toggleReady(){
    if(!connected) return;
    const next = !myReady;

    // On envoie un message simple. Si ton ws_server.py utilise un autre nom,
    // on l’ajuste au bloc suivant en 10 secondes avec ton retour.
    send({ t:"ready", ready: next });

    // UI optimiste (le serveur renverra lobby et confirmera)
    setMyReady(next);
  }

  function startGame(){
    if(!connected || !isHost) return;
    send({ t:"start" });
    log("Demande de démarrage envoyée.", "sys");
    closeMenu();
  }

  function doAction(){
    if(!connected) return;
    // placeholder: on fera la vraie UI vote/choix cible dans le prochain bloc
    send({ t:"action" });
    log("Action envoyée (placeholder).", "sys");
  }

  function applyHostSettings(){
    if(!connected || !isHost) return;

    const payload = {
      t: "settings",
      wolvesCount: clampInt(optWolvesCount.value, 1, 4, 1),
      hunterEnabled: optHunterEnabled.value === "1",
      revealMs: clampInt(optRevealMs.value, 1000, 120000, 12000),
      nightMs: clampInt(optNightMs.value, 1000, 180000, 20000),
      talkMs: clampInt(optTalkMs.value, 1000, 300000, 22000),
      voteMs: clampInt(optVoteMs.value, 1000, 180000, 20000),
      hunterMs: clampInt(optHunterMs.value, 1000, 180000, 15000),
    };

    send(payload);
    log("Paramètres (hôte) envoyés.", "sys");
  }

  function clampInt(v, min, max, def){
    const n = parseInt(v, 10);
    if(Number.isNaN(n)) return def;
    return Math.max(min, Math.min(max, n));
  }

  // ---------------------------
  // Misc
  // ---------------------------
  function copyInviteLink(){
    const url = location.href;
    navigator.clipboard?.writeText(url).then(()=>{
      log("Lien copié. Envoie-le à tes amis.", "ok");
    }).catch(()=>{
      log("Copie manuelle: " + url, "sys");
    });
  }

  function goHome(){
    if(connected){
      try{ send({t:"leave"}); } catch {}
      try{ ws.close(); } catch {}
    }
    location.href = HOME_URL;
  }

  function editWS(){
    const next = prompt("URL WebSocket (wss://...)", wsUrl);
    if(!next) return;
    wsUrl = next.trim();
    localStorage.setItem("lg_ws_url", wsUrl);
    wsShown.textContent = wsUrl;
    log("WS changé. Reconnecte-toi.", "sys");
  }

  // ---------------------------
  // Wire events
  // ---------------------------
  function openMenu(){ drawer.classList.add("open"); overlay.classList.add("open"); }
  function closeMenu(){ drawer.classList.remove("open"); overlay.classList.remove("open"); }

  $("btnMenu").addEventListener("click", openMenu);
  $("btnCloseMenu").addEventListener("click", closeMenu);
  overlay.addEventListener("click", closeMenu);

  $("btnEditWS").addEventListener("click", editWS);

  btnConnect.addEventListener("click", connect);
  btnDisconnect.addEventListener("click", disconnect);

  btnReady.addEventListener("click", toggleReady);
  btnReadyMenu.addEventListener("click", toggleReady);

  btnStart.addEventListener("click", startGame);
  btnStartMenu.addEventListener("click", startGame);

  btnAction.addEventListener("click", doAction);

  btnHome.addEventListener("click", goHome);
  btnQuitToHome.addEventListener("click", goHome);

  btnClearLog.addEventListener("click", clearLog);

  btnSend.addEventListener("click", () => {
    const t = (chatInput.value||"").trim();
    if(!t) return;
    chatInput.value = "";
    send({ t:"chat", text: t });
  });

  chatInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      btnSend.click();
    }
  });

  btnCopyLink.addEventListener("click", copyInviteLink);
  btnApplySettings.addEventListener("click", applyHostSettings);

  window.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      if(drawer.classList.contains("open")) closeMenu();
      else openMenu();
    }
  });

  // Init
  wsShown.textContent = wsUrl;
  setStatus(false, "Déconnecté");
  setPhase("—", "Connecte-toi via le menu (☰).");
  settingsLine.textContent = "Paramètres: —";

  const savedName = localStorage.getItem("lg_name");
  if(savedName) nameInput.value = savedName;

  // minimal init visuals
  renderPlayers();
  syncHostUI();
  setMyReady(false);
})();
</script>

</body>
</html>
